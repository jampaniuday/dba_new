set termout off
set pagesize 1000
set feedback off
SET VERIFY OFF
SET ECHO OFF

set markup HTML ON HEAD " -
<style type='text/css'> - 
  body {font:10pt Arial,Helvetica,sans-serif; color:black; background:White;} -
  p {   font:10pt Arial,Helvetica,sans-serif; color:black; background:White;} -
        table,tr,td {font:10pt Arial,Helvetica,sans-serif; color:Black; background:#f7f7e7; -
        padding:0px 0px 0px 0px; margin:0px 0px 0px 0px; white-space:nowrap;} -
  th {  font:bold 10pt Arial,Helvetica,sans-serif; color:#336699; background:#cccc99; -
        padding:0px 0px 0px 0px;} -
  h1 {  font:16pt Arial,Helvetica,Geneva,sans-serif; color:#336699; background-color:White; -
        border-bottom:1px solid #cccc99; margin-top:0pt; margin-bottom:0pt; padding:0px 0px 0px 0px;} -
  h2 {  font:bold 10pt Arial,Helvetica,Geneva,sans-serif; color:#336699; background-color:White; -
        margin-top:4pt; margin-bottom:0pt;} a {font:9pt Arial,Helvetica,sans-serif; color:#663300; -
        background:#ffffff; margin-top:0pt; margin-bottom:0pt; vertical-align:top;} -
</style> -
<title>&1</title>" -
BODY "" -
TABLE "border='1' align='center' summary='Script output'" -
SPOOL ON ENTMAP OFF PREFORMAT OFF

spool &2

clear buffer

SET HEADING OFF
select '<h1>Sunday Maintanence - '||to_char(sysdate,'DD-MM-YYYY')||'</h1>' from dual;
SET HEADING ON

COLUMN INVALIC_O_CHECK_DESC HEADING 'INVALID OBJECTS' ENTMAP OFF
COLUMN FREE_SPACE FORMAT 99
COLUMN ENVIRONMENT FORMAT a12
BREAK ON ENVIRONMENT;

SELECT 	DB.ENVIRONMENT "ENVIRONMENT",
	RS.DB_NAME "DATABASE NAME",
	DECODE(JOB_CHECK_DESC,'OK','OK','<A HREF="#JOBS">'||JOB_CHECK_DESC||'</A>') "JOBS STATUS",
	DECODE(TS_CHECK_DESC,'OK','OK','<A HREF="#TSUSAGE">'||TS_CHECK_DESC||'</A>') "TABLESPACE USAGE",
        DECODE(FS_CHECK_DESC,'OK','<A HREF="#FSUSAGE"> OK </A>','<A HREF="#FSUSAGE">'||FS_CHECK_DESC||'</A>') "TS GROWTH IN FS",
	DECODE(BACKUP_CHECK_DESC,'OK','OK','<A HREF="#EXPSTATUS">'||BACKUP_CHECK_DESC||'</A>') "EXPORTS STATUS",
	DECODE(INVALIC_C_CHECK_DESC,'OK','OK','<A HREF="#CONST">'||INVALIC_C_CHECK_DESC||'</A>') "INVALID CONSTRAINTS",
	DECODE(INVALIC_I_CHECK_DESC,'OK','OK','<A HREF="#INDEX">'||INVALIC_I_CHECK_DESC||'</A>') "INVALID INDXES",
	DECODE(INVALIC_O_CHECK_DESC,'OK','OK','<A HREF="#OBJECTS">'||INVALIC_O_CHECK_DESC||'</A>') "INVALID OBJECTS",
	DECODE(DISABLED_JOB_CHECK_DESC,'OK','OK','<A HREF="#DISABLED_JOB">'||DISABLED_JOB_CHECK_DESC||'</A>') "DISBALED JOBS"
FROM   SM_REPORTS_SUMMERY RS,
       SM_DATABASES DB
WHERE REPORT_NAME='&1' AND
      RS.DB_NAME=DB.DB_NAME AND DB.STATUS='Y'
ORDER BY DB.REP_ORDER,RS.DB_NAME;

SET HEADING OFF
SELECT '<A NAME=''JOBS''></A> BROKEN JOBS REPORT ' "BROKEN JOBS REPORT"
FROM   DUAL;
SET HEADING ON

SELECT DB_NAME,OWNER,JOB_NAME,STATUS,ACTUAL_START_DATE "START DATE",LOG_ID,LOG_DATE
FROM SM_SCHEDULER_JOBS
WHERE REPORT_NAME='&1'
AND LOG_ID!=3
ORDER BY 1,2
/

SET HEADING OFF
SELECT '<A NAME=''DISABLED_JOB''></A> DISABLED JOBS REPORT ' "DISABLED JOBS REPORT"
FROM   DUAL;
SET HEADING ON

SELECT DB_NAME,OWNER,JOB_NAME,STATUS,ACTUAL_START_DATE "START DATE",LOG_ID,LOG_DATE
FROM SM_SCHEDULER_JOBS
WHERE REPORT_NAME='&1'
AND LOG_ID=3
ORDER BY 1,2
/

SET HEADING OFF
SELECT '<A NAME=''CONST''></A> INVALID CONSTRAINTS REPORT ' "INVALID CONSTRAINTS REPORT"
FROM   DUAL;
SET HEADING ON

SELECT DB_NAME "DATABASE NAME",OWNER,OBJECT_NAME "OWNER NAME",TABLE_NAME "TABLE NAME"
FROM SM_INVALID_OBJECTS
WHERE OBJECT_TYPE='CONSTRAINT' AND REPORT_NAME='&1'
ORDER BY 1,2
/

SET HEADING OFF
SELECT '<A NAME=''INDEX''></A> INVALID INDEXES REPORT ' "INVALID INDEXES REPORT"
FROM   DUAL;
SET HEADING ON

SELECT DB_NAME "DATABASE NAME",OWNER,OBJECT_NAME "OWNER NAME",TABLE_NAME "TABLE NAME"
FROM SM_INVALID_OBJECTS
WHERE OBJECT_TYPE='INDEX' AND REPORT_NAME='&1'
ORDER BY 1,2
/

SET HEADING OFF
SELECT '<A NAME=''OBJECTS''></A> INVALID OBJECTS REPORT ' "INVALID OBJECTS REPORT"
FROM   DUAL;
SET HEADING ON

SELECT DB_NAME "DATABASE NAME",OWNER,OBJECT_NAME "OWNER NAME",OBJECT_TYPE "OBJECT TYPE"
FROM SM_INVALID_OBJECTS
WHERE OBJECT_TYPE NOT IN ('CONSTRAINT','INDEX') AND REPORT_NAME='&1'
ORDER BY 1,2
/

SET HEADING OFF
SELECT '<A NAME=''OBJECTS''></A> VALIDATE COMMANDS REPORT ' "VALIDATE COMMANDS REPORT"
FROM   DUAL;
SET HEADING ON

SELECT DB_NAME "DATABASE NAME",COMMAND_TYPE "COMMAND TYPE",COMMAND 
FROM SM_REPORT_COMMANDS
WHERE REPORT_NAME='&1'
ORDER BY 1,2
/

SET HEADING OFF
SELECT '<A NAME=''TSUSAGE''></A> TABLESPACE USAGE ERRORS REPORT ' "TABLESPACE USAGE ERRORS REPORT"
FROM   DUAL;
SET HEADING ON

SET PAGESIZE 20000
COLUMN FREE_PCT FORMAT 99
COLUMN ENVIRONMENT FORMAT a12


SELECT SD.ENVIRONMENT,ST.DB_NAME "DATABASE NAME",TS_NAME "TABLESPACE",ROUND(TOTAL_SPACE) "TOTAL SPACE (MB)",ROUND(FREE_SPACE) "FREE SPACE (MB)",ROUND(FREE_PCT) "PCT FREE",TS_DATE "CHECK DATE"
FROM SM_TABLESPACES ST,
     SM_DATABASES SD
WHERE REPORT_NAME='&1' AND
      SD.DB_NAME=ST.DB_NAME
      AND ROUND(FREE_PCT) <= 20 AND SD.STATUS='Y'
ORDER BY SD.REP_ORDER ASC,ST.DB_NAME ASC,6 ASC
/

SET HEADING OFF
SELECT '<A NAME=''TSUSAGE''></A> TABLESPACE FULL USAGE REPORT ' "TABLESPACE FULL USAGE REPORT"
FROM   DUAL;
SET HEADING ON


SELECT SD.ENVIRONMENT,ST.DB_NAME "DATABASE NAME",TS_NAME "TABLESPACE",ROUND(TOTAL_SPACE) "TOTAL SPACE (MB)",ROUND(FREE_SPACE) "FREE SPACE (MB)",ROUND(FREE_PCT) "PCT FREE",TS_DATE "CHECK DATE"
FROM SM_TABLESPACES ST,
     SM_DATABASES SD
WHERE REPORT_NAME='&1' AND
      SD.DB_NAME=ST.DB_NAME AND SD.STATUS='Y'	
ORDER BY SD.REP_ORDER ASC,ST.DB_NAME ASC,6 ASC
/

SET HEADING OFF
SELECT '<A NAME=''FSUSAGE''></A> TS GROWTH IN FS REPORT ' "TS GROWTH IN FS REPORT"
FROM   DUAL;
SET HEADING ON


select t.check_date,t.host_name , t.db_name ,t.fs ,t.fs_free_space, t.fs_size , t.TS_GROWTH_POTENCIAL , (t.FS_FREE_SPACE - t.TS_GROWTH_POTENCIAL ) as "Space Left after ts growth"
from  sm.SM_FS_STATUS t
WHERE t.check_date = ( select max(check_date) from sm.SM_FS_STATUS where t.db_name = db_name )
and IS_DR ='N'
/

SET HEADING OFF
SELECT '<A NAME=''EXPSTATUS''></A> EXPORTS STATUS REPORT ' "EXPORTS STATUS REPORT"
FROM   DUAL;
SET HEADING ON

SELECT *
FROM SM_EXPORT_STATUS
WHERE trunc(check_date) = (select trunc(max(check_date)) FROM sm_export_status )
/


SET HEADING OFF
SELECT '<A NAME=''TSUSAGE_NOEXTENTS''></A> TABLESPACE USAGE REPORT - NO EXTENTS CALCULATIONS' "TABLESPACE USAGE REPORT"
FROM   DUAL;
SET HEADING ON

SET PAGESIZE 1000
COLUMN FREE_PCT FORMAT 99
COLUMN ENVIRONMENT FORMAT a12

SELECT SD.ENVIRONMENT,ST.DB_NAME "DATABASE NAME",TS_NAME "TABLESPACE",ROUND(TOTAL_SPACE_NON_EXT) "TOTAL SPACE",ROUND(FREE_SPACE_NON_EXT) "FREE SPACE",ROUND(PCF_FREE_NON_EXT) "PCT FREE",TS_DATE "CHECK DATE"
FROM SM_TABLESPACES ST,
     SM_DATABASES SD
WHERE REPORT_NAME='&1' AND
      SD.DB_NAME=ST.DB_NAME AND SD.STATUS='Y'
ORDER BY SD.REP_ORDER,ST.DB_NAME ASC,6 ASC
/

spool off
set markup html off spool off
set termout on
exit
